name: Auto Merge Contributor PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Auto merge contributors PR
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;

            if (pr.user.type === "Bot") {
              console.log("Bot PR detected, skipping.");
              return;
            }

            console.log(`Checking PR #${pr.number} by @${author}`);

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            if (files.length !== 1 || files[0].filename !== "docs/CONTRIBUTORS.md") {
              console.log("PR modifies more than docs/CONTRIBUTORS.md, skipping.");
              return;
            }

            const file = files[0];

            if (!file.patch) {
              console.log("No patch found (diff too large?), skipping.");
              return;
            }

            const patchLines = file.patch.split("\n");

            const removedLines = patchLines.filter(
              (line) => line.startsWith("-") && !line.startsWith("---")
            );

            if (removedLines.length > 0) {
              console.log("PR removes lines. Skipping for safety.");
              return;
            }

            const addedLines = patchLines.filter(
              (line) => line.startsWith("+") && !line.startsWith("+++")
            );

            if (addedLines.length === 0) {
              console.log("No added lines found, skipping.");
              return;
            }

            if (addedLines.length > 1) {
              console.log("Too many lines added. Possible spam. Skipping.");
              return;
            }

            // Escape author for regex safety
            const escapedAuthor = author.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

            const strictLineRegex = new RegExp(
              `^\\+\\s*[-*]\\s+@${escapedAuthor}\\s*$`,
              "i"
            );

            const invalidLines = addedLines.filter(line => !strictLineRegex.test(line));

            if (invalidLines.length > 0) {
              console.log("Invalid format detected. Skipping merge.");
              console.log("Invalid lines:", invalidLines);
              return;
            }

            console.log("All added lines match strict format.");

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: "squash",
                commit_title: `Add @${author} to contributors`,
                commit_message: `Auto-merged contribution from @${author}`
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ðŸŽ‰ Congrats @${author}! Your contribution has been automatically merged. Welcome aboard! ðŸš€`
              });

              console.log("PR merged successfully.");
            } catch (error) {
              console.log("Merge failed:", error.message);
            }
